---
layout: post
title: 搜狗云输入法使用感受和实现原理初探
tags:
- Cloud Computing
- Research
- Technique
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  views: '541'
---
前两天下载搜狗输入法的时候就看到官网上有提示说,搜狗将在北京时间11月2日下午14:00推出一个新的概念产品,完了一直在写作业竟然给忘记了.今天早上在google wave中群聊的时候kurt给我提醒了.隧 login到了<a title="搜狗云输入法官网" href="http://pinyin.sogou.com/cloud/">http://pinyin.sogou.com/cloud</a> 进行观望.

<ul>

	<li>使用初探</li>

</ul>

<ol>

	<li>安装</li>

</ol>

按照官网上的说明将搜狗云输入法链接保存到自己的书签中.或者直接用鼠标将搜狗云输入法图标拖到书签中.

<div style="text-align: justify;"><img src="/assets/uploads/2009/11/200911041750.jpg" alt="200911041750.jpg" width="373" height="94" /></div>

2.使用



点击刚才保存的云输入法书签.将会启动一个悬浮的输入法框.

<img src="/assets/uploads/2009/11/usageofcloudinput.jpg" alt="云输入法的使用" width="480" height="270" />

<ul>

	<li>使用感受</li>

</ul>

<ol>

	<li>搜狗云输入法的页面兼容性还不是很好的.</li>

</ol>

在很多的页面上当点击启用搜狗云输入法时会出现也没反应缓慢,同事提示出现Unresponsive script Warning. 然后输入法就会崩溃.



<img src="/assets/uploads/2009/11/scripterror.jpg" alt="Scripts Error" width="480" height="220" />



2.输入法的反应速度还是很慢的.这个原因会在后面云输入法实现原理初探中具体说明.所以当网速慢的时候使用起来会很不爽.尤其是不能体验狂敲键盘的感觉.另外一个方面,输入法的取词查询都是在服务器端进行的.所以如果云输入法有像搜狗客户端输入法那样近2亿多用户的时,状况也是不敢想象的.



3.在可以使用搜狗云输入法页面的情况下.可支持的输入页面部分也是很有限的.地址栏中好像不支持输入.

<ul>

	<li>原理初探</li>

</ul>

这是官方网站上给出的一张图片



<img src="/assets/uploads/2009/11/cloudinputyuanli.jpg" alt="云输入法原理" width="480" height="149" />



云输入法是基于B/S架构的.无需安装.运算均在服务器端进行. 为了搞清楚云输入法到底是怎么搞的.这里借用了firefox下一个很有名的插件.Firebug.



首先解释一个问题,当我们点击启动搜狗云输入法时我实际做了什么事情.



当将鼠标放到书签上时.注意观察firefox下面的地址栏.



<img src="/assets/uploads/2009/11/initialcloudinput.jpg" alt="点击书签出发js" width="479" height="21" />



稍微懂点web和脚本语言的都知道.这可能是一段javascript代码.



Bingo!



这就是启动云输入法的完整代码. <a href="http://anotherbug.com/initial_js_code.txt">点击这里下载JS</a>

<img src="/assets/uploads/2009/11/jscodes.jpg" alt="javascripts代码" width="582" height="114" />



这段JS代码首先判断当前浏览器是否是IE内核.以及判断当前页面是不是UTF_8编码.如果ie=1并且是UTF_8编码的页面则调用<a href="http://web.pinyin.sogou.com/web_ime/init2_utf8.php">http://web.pinyin.sogou.com/web_ime/init2_utf8.php</a> 否则调用<a href="http://web.pinyin.sogou.com/web_ime/init2.php">http://web.pinyin.sogou.com/web_ime/init2.php</a> 页面.



同时在当前页面body上动态生成一个Script标签.script标签的src属性是上面要调用的页面地址.初始化完成后会生成一个script元素.



<img src="/assets/uploads/2009/11/scriptinputchoud.jpg" alt="javascript代码" width="480" height="60" />



如果此时页面没有报JS warning的话恭喜你走过了第一关.不出意外你会看到这个图标



<img src="/assets/uploads/2009/11/cloudinputsogou.jpg" alt="云输入法" width="197" height="74" />



注意这个和平时见到的图标不一样噢. (不都差不多嘛? ==No 这个是在页面上的! ==汗~)



这个图标其实使用js的div生成的一个浮动区域.



这个是浮动区域的javascript代码. <a href="http://anotherbug.com/cloud_input_float_div.txt">点击这里下载JS</a>



<img src="/assets/uploads/2009/11/floatinputcloud.jpg" alt="云输入法图标代码" width="480" height="178" />



这个时候基本框架都有了.OK,当我们输入汉字的时候是什么情况呢?



我们来做个测试.当在页面输入拼音 shiying 的时候,我们看到页面会生成n多script标签.



<a href="http://web.pinyin.sogou.com/web_ime/get_ajax/shi.key">http://web.pinyin.sogou.com/web_ime/get_ajax/shi.key</a>



<a href="http://web.pinyin.sogou.com/web_ime/get_ajax/shi.key">http://web.pinyin.sogou.com/web_ime/get_ajax/s.key</a>



...etc



到这里大家可能都比较疑惑.这些东西是什么.(注意这些URL是可以访问的.)进去看看呗.(这部分工作交给观众自己进行.)



<img src="/assets/uploads/2009/11/screen-shot-09-11-04.png" alt="云输入法页面" width="736" height="460" />



进去之后可能傻了.一堆乱码? No, definitely no.猜想可能是页面经过了编码. 是什么编码呢?凭经验我猜应该是URL Encode.OK那就decode一下呗.



<a href="http://www.nengcha.com/code/urlDecode.asp?keycode=%25E6%2598%25AF%25EF%25BC%259A3%2509+%25E6%2597%25B6%25EF%25BC%259A3%2509+%25E4%25BA%258B%25EF%25BC%259A3%2509+%25E4%25BD%25BF%25EF%25BC%259A3%2509+%25E5%25B8%2582%25EF%25BC%259A3%2509+%25E5%25BC%258F%25EF%25BC%259A3%2509+%25E5%258D%2581%25EF%25BC%259A3%2509+%25E5%25AE%259E%25EF%25BC%259A3%2509+%25E5%25B8%2588%25EF%25BC%259A3%2509+%25E8%25A7%2586%25EF%25BC%259A3%2509+%25E7%259F%25B3%25EF%25BC%259A3%2509+%25E5%25AE%25A4%25EF%25BC%259A3%2509+%25E8%25AF%2595%25EF%25BC%259A3%2509+%25E5%25A3%25AB%25EF%25BC%259A3%2509+%25E9%25A3%259F%25EF%25BC%259A3%2509+%25E5%258F%25B2%25EF%25BC%259A3%2509+%25E4%25B8%2596%25EF%25BC%259A3%2509+%25E8%25AF%2597%25EF%25BC%259A3%2509+%25E6%2596%25BD%25EF%25BC%259A3%2509+%25E5%25A7%258B%25EF%25BC%259A3&amp;key=%E6%98%AF%EF%BC%9A3%09+%E6%97%B6%EF%BC%9A3%09+%E4%BA%8B%EF%BC%9A3%09+%E4%BD%BF%EF%BC%9A3%09+%E5%B8%82%EF%BC%9A3%09+%E5%BC%8F%EF%BC%9A3%09+%E5%8D%81%EF%BC%9A3%09+%E5%AE%9E%EF%BC%9A3%09+%E5%B8%88%EF%BC%9A3%09+%E8%A7%86%EF%BC%9A3%09+%E7%9F%B3%EF%BC%9A3%09+%E5%AE%A4%EF%BC%9A3%09+%E8%AF%95%EF%BC%9A3%09+%E5%A3%AB%EF%BC%9A3%09+%E9%A3%9F%EF%BC%9A3%09+%E5%8F%B2%EF%BC%9A3%09+%E4%B8%96%EF%BC%9A3%09+%E8%AF%97%EF%BC%9A3%09+%E6%96%BD%EF%BC%9A3%09+%E5%A7%8B%EF%BC%9A3">点击这里进行URL decode</a> (进入页面后点击"反编码/解码",嘿嘿.) 看看参考译文三或者四.你会大叫, 我靠,这不就是输入法的候选词么.



Bingo (again~)!



测试中发现这些&lt;script&gt;标签是动态增减的.当你很快输入 "s h i y o n g"时.会相应生成"s.key","sh.key","shi.key"...完了一段时间.大概4-5秒钟.这些前面的候选词的script标签会自动消失.



OK,现在总结下搜狗的这款概念产品云输入法的大概运行流程:

<ol>

	<li>点击"启动书签云输入法书签"==进行js初始化,确定web页面的调用.生成页面script标签</li>

	<li>进行.php页面调用同时在生成一个浮动的div标签.完成输入法界面初始化. 这个过程会出现JS不兼容等情况.</li>

	<li>用户输入拼音,web_ime/init2.php监视用户输入,通过AJAX与服务器端通信.查询相关字库.同时返回URL编码过后的结果进行汉字候选.</li>

	<li>候选字动态增减.对应的是页面中&lt;script&gt;标签中候选字的增减.</li>

</ol>

云输入法的瓶颈:

<ol>

	<li>AJAX在进行数据传输时的延迟.云输入法面对的是用户快速的键盘输入.对数据传输相应要求很高.Data latency要极小.</li>

	<li>词库查询的响应时间,多用户查询是缓存,智能词频.(估计这块搜狗能够搞定.只不过在服务器端装了词库而已.只需要相应的IO优化).</li>

	<li>JS构造页面的时间.在页面body里频繁的插入和删除element.谁也受不了呀.可能造出内存消耗严重和页面崩溃,etc.</li>

</ol>

部分问题探讨:

<ol>

	<li><a href="http://www.google.cn/search?hl=zh-CN&amp;source=hp&amp;q=online+chinese+input&amp;btnG=Google+%E6%90%9C%E7%B4%A2&amp;aq=f&amp;oq=">在线汉字输入</a>老早就有,为什么就只有搜狗的叫做云输入法阿? (谁告诉我下?)</li>

	<li>blog中的一个问题.在使用感受中,第三条我写了在地址栏中无法使用云输入法,为撒?? (这个答对有奖.可以DM我,私下回答哈^_^!)</li>

</ol>
