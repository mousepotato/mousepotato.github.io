---
layout: post
title: Windows 7 下搭建LDAP服务器并使用JNDI访问手记
tags:
- LDAP
- Technique
status: publish
type: post
published: true
meta:
  views: '1398'
  _edit_last: '1'
---
五一闲来没事，加上项目正在进行UAT。抽空研究了一下LDAP相关知识。随手做一个记录。



为了方便阅读还是先介绍一下什么是LDAP?

<h3>前言、Lightweight Directory Access Protocol:</h3>

The <strong>Lightweight Directory Access Protocol</strong> , or <strong>LDAP</strong> ,is an <a href="http://en.wikipedia.org/wiki/Application_protocol">application protocol</a> for querying and modifying <a href="http://en.wikipedia.org/wiki/Directory_service">directory services</a> running over <a href="http://en.wikipedia.org/wiki/Internet_protocol_suite">TCP/IP</a> .(<a href="http://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" target="_blank">via wikipedia</a> )。LDAP全称是一个轻量级的目录访问协议，它是建立在TCP/IP基础之上的用来查询和修改目录服务的。这是照着wiki翻译的，但是有人要问了什么是directory Service（目录服务）?



按照wiki的说法的话讲：在软件行业，目录就如同一个字典，他使得通过某一名称去查找绑定在该名称上的值得方式成为一种可能。有点类似Java中Map的概念。a <strong>directory service</strong> is simply the software system that stores, organizes and provides access to information in a directory. 一个目录服务就是一个简单的软件系统，在这个目录上提供了存取和组织信息的功能。LDAP目录中可以存储各种类型的数据：电子邮件地址、邮件路由信息、人力资源数据、公用密匙、联系人列表，等等。



OK，进入正题。Google搜索 <a href="http://www.google.cn/search?hl=zh-CN&amp;newwindow=1&amp;q=windows+ldap%E6%9C%8D%E5%8A%A1%E5%99%A8&amp;revid=2007296909&amp;ei=_9b7SZixPNGgkQXTp4TiBA&amp;sa=X&amp;oi=revisions_inline&amp;resnum=0&amp;ct=broad-revision&amp;cd=3" target="_blank">windows ldap服务器</a> ，终于找到了一个比较好的流行的：<a href="http://download.bergmans.us/openldap/openldap-2.2.29/openldap-2.2.29-db-4.3.29-openssl-0.9.8a-win32_Setup.exe" target="_blank">OpenLDAP（点击下载）</a> 。

<h3>一、OpenLDAP安装和配置</h3>

安装还是比较简单的，一直next就好。

<p align="center"><a href="/assets/uploads/2009/05/image.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" src="/assets/uploads/2009/05/image-thumb.png" border="0" alt="image" width="256" height="199" /> </a></p>



这里记得把上面2个都选上，将LDAP注册为系统的一个服务，默认安装位置：C:Program FilesOpenLDAP，



进入安装目录，编辑<span style="color: #0000ff;">slapd.conf</span> 文件：



找到



ucdata-path    ./ucdata

include     ./schema/core.schema



在下面加入：（<span style="color: #004040;">注意你的系统路径，可能随安装位置不同而稍有差异</span> ）



include   ./schema/core.schema

include  ./schema/corba.schema

include  ./schema/dyngroup.schema

include  ./schema/java.schema

include  ./schema/misc.schema

include  ./schema/cosine.schema

include  ./schema/nis.schema

include  ./schema/inetorgperson.schema

include  ./schema/openldap.schema



这个搞定以后，在同一文件后面的（大概65-66行，修改）



suffix        "o=anotherbug,c=com"

rootdn      "cn=manager,o=anotherbug,c=com"



还有第70行的位置 ： rootpw        secret，这里要修改为加密后的密码。



具体操作：



打开命令行，定位到安装目录下，输入：slappasswd -h {MD5} –s “替换为你想要设置的密码，无引号”

<p align="center"><a href="/assets/uploads/2009/05/image1.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" src="/assets/uploads/2009/05/image-thumb1.png" border="0" alt="image" width="272" height="181" /> </a></p>

<p align="left">将生成的MD5密文：{MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==填入原来secret位置。</p>

<p align="left"></p>

<p align="left">OK至此配置已经搞定，可以测试一下服务了。打开命令行转到安装目录下输入：sldapd -d 1</p>

<p align="left"><a href="/assets/uploads/2009/05/image2.png"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="image" src="/assets/uploads/2009/05/image-thumb2.png" border="0" alt="image" width="304" height="201" /> </a></p>

<p align="left">至此LDAP服务器已经搭建并可以跑起来了.下面要来测试怎么倒入.ldif格式的数据了。</p>



<!--more-->

<h3>二、<strong>建立条目（Entry）</strong> ,导入 ldif 后缀名文件</h3>

ldif：LDAP Data Interchange Format，基于文本。有两种类型的 LDIF 文件：第一种是描述 Directory 条目数据的，第二种是描述更新条目的。我们主要看怎么描述条目的。



打开编辑器（如Editplus,UltraEdit等），新建test.ldif内容如下：



dn: o=anotherbug,c=com

objectClass: dcObject

objectClass: organization

o: anotherbug

dc: com



dn: uid=mousepoato, o=anotherbug,c=com

uid: mousepoato

objectClass: inetOrgPerson

mail: paradise.lsj@gmail.com

userPassword: admin

labeledURI: <a href="http://anotherbug.com/blog">http://anotherbug.com/blog</a>

sn: Li

cn: test



注意ldif文件对格式的要求非常严格，<span style="color: #ff00ff;">属性要以冒号和空格与值隔开</span> ，<span style="color: #0000ff;">并且其他地方不允许有空格</span> 。否则当你导入ldif文件时，会提示出现“<strong>ldap_add: Invalid syntax (21)</strong> ”等诸多错误，另外在我机器上测试，<span style="color: #000080;">ldif对中文支持也还不好</span> ，比如我将最后的cn: test改为 cn: 鼠标土豆，导入就会报错。



写完保存到安装目录下。在命令行输入：

<blockquote>ldapadd -c -x -D "cn=manager,o=anotherbug,c=com" -w “刚才替换secret出的密码明文” -f test.ldif</blockquote>

<p align="left">运行命令后结果如下：</p>

<p align="center"><a href="/assets/uploads/2009/05/image3.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" src="/assets/uploads/2009/05/image-thumb3.png" border="0" alt="image" width="345" height="237" /> </a></p>



注意我们在ldapadd后面加上了 ”–c “ 参数，他会一直运行不会因错误而终止，比如对系统已经存在的entry命令会提示但不会中止。

<h3>三、LDAP查看工具</h3>

可能大家看了这么多感觉还是很抽象，我们需要一个GUI看看LDAP到底是个什么东东。



这里推荐两个浏览工具

<h4>1、<a href="http://www.blogjava.net/Files/Unmi/LdapBrowser282.rar" target="_blank">LdapBrowser</a></h4>

这是个Java 开发的 LDAP Browser/Editor 工具，不但跨平台(Windows, Unix-like)，而且功能非常完整，速度又快。运行起来的界面时这个样子的。



<a href="/assets/uploads/2009/05/image4.png"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="image" src="/assets/uploads/2009/05/image-thumb4.png" border="0" alt="image" width="376" height="253" /> </a>

<h4>2、<a href="http://www.ldapadministrator.com/download_survey.htm?download=ldapadmin-4.0.8205.0-x86-eng.msi&amp;version=la2008" target="_blank">Softrra LDAP Administrator 2009</a></h4>

这是一个比较强大和专业的客户端，涵盖了大多数企业的LDAP服务类型。



一直下一步安装成功后，它的配置也是比较简单的：



<a href="/assets/uploads/2009/05/7.jpg"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="7" src="/assets/uploads/2009/05/7-thumb.jpg" border="0" alt="7" width="437" height="292" /> </a> 新建一个profile，命名为Local_LDAP



<a href="/assets/uploads/2009/05/8.jpg"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="8" src="/assets/uploads/2009/05/8-thumb.jpg" border="0" alt="8" width="439" height="279" /> </a>



<a href="/assets/uploads/2009/05/11.jpg"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="11" src="/assets/uploads/2009/05/11-thumb.jpg" border="0" alt="11" width="452" height="347" /> </a> 配置连接信息



<a href="/assets/uploads/2009/05/12.jpg"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="12" src="/assets/uploads/2009/05/12-thumb.jpg" border="0" alt="12" width="471" height="329" /> </a>



这是完整配置好后的效果

<h3>四、通过 JNDI api操作LDAP例子</h3>

Javax里面提供的JNDI为我们封装好了对LDAP 的directory service进行存取查询的函数，可以方便实用。



贴上我用JUnit4写一个对LADP服务器进行测试的代码供参考：



private static Logger log = Logger.getLogger(TestLdapOper.class);

DirContext context = null;

TestLdap tldap = null;



@Before

public void init() throws NamingException {

tldap = new TestLdap();

context = tldap.getContext();// 获取context

}



@Test

@Ignore

public void testInsert() throws NamingException {

tldap.addEntry(context, "uid=IBM,o=anotherbug,c=com");

}



@SuppressWarnings("unchecked")

@Test

public void testGetAttributes() throws NamingException {

List attNameList = new ArrayList();

attNameList.add("o");

attNameList.add("dc");

attNameList.add("objectClass");

Map map = JNDIUitl.getAttributes(context, "o=anotherbug,c=com", attNameList);

Iterator keyValuePairs = map.entrySet().iterator();

for (int i = 0; i &lt; map.size(); i++) {

Map.Entry entry = (Map.Entry) keyValuePairs.next();

Object key = entry.getKey();

Object value = entry.getValue();

log.info(key + "==key");

log.info(value + "--value");

}

}



@SuppressWarnings("unchecked")

@Test

public void testGetAttriValues() throws NamingException {

assertEquals("anotherbug.com", JNDIUitl.getAttributeValues(context, "o=anotherbug,c=com", "dc").get(0) + "");

List lst = new ArrayList();

lst = JNDIUitl.getAttributeValues(context, "o=anotherbug,c=com", "objectClass");

assertEquals("organization", lst.get(1) + "");

for (int i = 0; i &lt; lst.size(); i++) {

log.info(lst.get(i));

log.info(ReflectionToStringBuilder.toString(lst.get(i)).toString());

}

}



@SuppressWarnings("unchecked")

@Test

public void testSearchContext() throws NamingException {

List list = JNDIUitl.searchContextSub(context, "o=anotherbug,c=com", "(objectClass=*)");

for (int i = 0; i &lt; list.size(); i++) {

log.info(list.get(i));

}

}



@After

public void destroy() throws NamingException {

context.close();

}
